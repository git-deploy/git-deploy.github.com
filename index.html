<!DOCTYPE html>

<!--
  Google HTML5 slide template

  Authors: Luke Mahé (code)
           Marcin Wichary (code and design)
           
           Dominic Mazzoni (browser compatibility)
           Charles Chen (ChromeVox support)

  URL: http://code.google.com/p/html5slides/
-->

<html>
  <head>
    <title>FOSDEM git-deploy talk</title>

    <meta charset='utf-8'>
    <script
      src='./slides.js'></script>
  </head>
  
  <style>
    /* Your individual styles here, or just use inline styles if that’s
       what you want. */
    
    
  </style>

  <body style='display: none'>

    <section class='slides layout-regular template-default'>
      
      <!-- Your slides (<article>s) go here. Delete or comment out the
           slides below. -->
        
      
      <article>
        <h1>
          Rapid real-world testing using git-deploy
        </h1>
        <p>
          Ævar Arnfjörð Bjarmason &lt;<a href="mailto:avarab@gmail.com">avarab@gmail.com</a>&gt;
          <br>
          February 5, 2012
        </p>
      </article>

      <article>
        <h2>
          What is git-deploy?
        </h2>

        <ul class='build'>
          <li>
            A deployment tool conceived and introduced at Booking.com in 2008
          </li>
          <li>
            We've made it open source, clone it on GitHub.
          </li>
          <li>
            You should use it, and here's why...
          </li>
      </article>

      <article>
        <h3>
          It's a tool to make deployments really easy
        </h3>
        <p>
          We've gone from deployments being a hard manual process, to
          doing dozens of them a day.
        </p>
        <p>
          <img style='height: 500px' src='images/deploys-per-month.png'>
        </p>
      </article>

      <article>
        <h3>
          It's highly configurable and pluggable
        </h3>
        <p>
          <img src='images/pushing_your_boundaries_1.jpg'>
        </p>
        <ul class='build'>
          <li>
            We use it to deploy around 20 environments.
          </li>
          <li>
            Those 20 environments have around 60 hooks between them to
            customize deployments.
          </li>
        </ul>
      </article>

      <article>
        <h3>
          What's the core concept behind it?
        </h3>
        <ul class='build'>
          <li>
            git-deploy will create an annotated git tag for all your
            rollouts.
          </li>
          <li>
            This gives you permanent git-level history of all your
            rollouts..
          </li>
        </ul>
        <p>
          <img src='images/tag-all-the-deploys.jpg' class='centered'>
        </p>

      </article>

            
      <article>
        <h3>So how does it actually work</h3>

        <ul class="build">
          <li>
            Rollouts are done from a designated git repository cloned
            from your main repository.
          </li>
          <li>
            Only one user can do a rollout at a time.
          </li>
          <li>
            Once you've locked the deployment server you can perform
            any git operation you want (<code>git
            pull/commit/cherry-pick/reset</code>).
          </li>
          <li>
            When you're ready you <i>sync</i>. This creates <b>a
            tag</b>.
          </li>
          <li>
            This calls <b>your</b> sync hook.
          </li>
          <li>
            When that's done you <i>finish</i> which unlocks
            deployments, pushes the tags, sends E-Mail etc.
          </li>
        </ul>
      </article>

      <article>
        <h3>Step 1: <i>start</i></h3>

        <ul class='build'>
          <li>Creates a <code>.git/deploy/lock</code> file in your
          deployment repository.</li>
        </ul>

        <pre>
$ git-deploy status; echo $?
# NOTE : No cron deployment currently in progress
0
</pre>

<pre>
$ git-deploy status; echo $?
# NOTE : cron rollout started - not synced yet (offapp-20120201-170104)
# NOTE : start: 2012-02-02 16:19:28     trunk   110bc23d8204dae87b2af259a02d47cd08711589        717     slanning
1
</pre>

<pre>
$ git-deploy start
# INFO : git fetch --tags origin 
# INFO : (not updating working directory)
# INFO : git fetch origin 
# INFO : (not updating working directory)
# INFO : From git.booking.com:/gitroot/main
# INFO :    0d9028e..65a8054  trunk      -> origin/trunk
# INFO : Starting step 'start' at 2012-02-02 16-22-01
# FATAL: You may not start a new rollout as it looks like one is already in progress!
# FATAL: Failed to create lock dir '.git/deploy' because 'File exists'
# FATAL: Log:
# FATAL:        start:  2012-02-02 16:19:28     trunk   110bc23d8204dae87b2af259a02d47cd08711589        717     slanning
</pre>

<pre>
$ git-deploy abort
# INFO : git fetch --tags origin 
# INFO : (not updating working directory)
# INFO : git fetch origin 
# INFO : (not updating working directory)
# INFO : From git.booking.com:/gitroot/main
# INFO :    65a8054..d79019a  trunk      -> origin/trunk
# INFO : Starting step 'abort' at 2012-02-02 16-22-36
# FATAL: Someone else is doing a rollout. You cannot proceed.
# FATAL: Log:
# FATAL:        start:  2012-02-02 16:19:28     trunk   110bc23d8204dae87b2af259a02d47cd08711589        717     slanning
</pre>

<pre>
PROD cron mc02cronapp-01 main (trunk $<) $ git-deploy --force abort
# INFO : git fetch --tags origin 
# INFO : (not updating working directory)
# INFO : git fetch origin 
# INFO : (not updating working directory)
# INFO : From git.booking.com:/gitroot/main
# INFO :    d79019a..1fba73a  trunk      -> origin/trunk
# INFO : Starting step 'abort' at 2012-02-02 16-23-07
# NOTE : Rolling back to offapp-20120201-170104
# NOTE : Rolled back to 'offapp-20120201-170104' succesfully
# INFO : wrote deploy file 'lib/.deploy'
# INFO : Not sending mail on action 'abort'. This can be configured with the 'send-mail-on-abort'
# INFO : Step 'abort' finished. Started at 2012-02-02 16:23:07; took 1 seconds to complete
# YAY  : 'abort' for 'cron' completed successfully
# INFO : git push --tags origin 
# INFO : (not updating working directory)
# INFO : Everything up-to-date
PROD cron mc02cronapp-01 main (trunk $<) $ git-deploy status
# NOTE : No cron deployment currently in progress
</pre>




        <ul class="build">
          <li>
            Rollouts are done from a designated git repository cloned
            from your main repository.
          </li>
          <li>
            Only one user can do a rollout at a time.
          </li>
          <li>
            Once you've locked the deployment server you can perform
            any git operation you want (<code>git
            pull/commit/cherry-pick/reset</code>).
          </li>
          <li>
            When you're ready you <i>sync</i>. This creates <b>a
            tag</b>.
          </li>
          <li>
            This calls <b>your</b> sync hook.
          </li>
          <li>
            When that's done you <i>finish</i> which unlocks
            deployments, pushes the tags, sends E-Mail etc.
          </li>
        </ul>
      </article>

      <article>
        <h3>
          So what does it actually do?
        </h3>
        <pre>
$ git tag -l | grep ^cron- | tail -n 10
cron-20120131-132746
cron-20120131-154834
cron-20120131-162155
cron-20120131-163859
cron-20120131-164816
cron-20120201-111613
cron-20120201-141449
cron-20120201-150915
cron-20120201-163202
cron-20120201-165948
        </pre>

        <p>
          It creates tags for every single rollout per-environment.
        </p>
      </article>
      
      <article>
        <h1 class='centered'>
          Thank you!, questions?
        </h1>

        <ul>
          <li><a href="http://github.com/avar/git-deploy">http://github.com/avar/git-deploy</a></li>
          <li>This talk is available in the <code>fosdem</code> branch of that repository</li>
          <li>Contact me at <a href="mailto:avarab@gmail.com">avarab@gmail.com</a></li>
        </ul>
        
      </article>

    </section>

  </body>
</html>
